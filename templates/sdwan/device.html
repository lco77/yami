{% extends "base.html" %}

{% block title %}Yami{% endblock %}

{% block content %}
<div class="row">
    <div class="col">
        <br>
        <h4>{{hostname}}</h4>
        <hr>
    </div>
</div>
<div class="row">
    <div class="col">
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" data-bs-toggle="tab" href="#tab1" aria-selected="true" role="tab">Summary</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" data-bs-toggle="tab" href="#tab2" aria-selected="false" role="tab" tabindex="-1">Version</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" data-bs-toggle="tab" href="#tab3" aria-selected="false" role="tab" tabindex="-1">Interfaces</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" data-bs-toggle="tab" href="#tab4" aria-selected="false" role="tab" tabindex="-1">Template Values</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link iproute" data-bs-toggle="tab" href="#tab5" aria-selected="false" role="tab" tabindex="-1">Route table</a>
        </li>
    </ul>
    <div class="tab-content">
        <div class="tab-pane fade active show" id="tab1" role="tabpanel">
            <div id="tab1-content">
                <div class="row">
                    <div class="col">
                <table class="table table-striped">
                    <tr>
                        <td><p class="text-primary"><b>Hostname</b></p></td>
                        <td>{{data.hostname}}</td>
                    </tr>
                    <tr>
                        <td><p class="text-primary"><b>IP Address</b></p></td>
                        <td>{{data.system_ip}}</td>
                    </tr>
                    <tr>
                        <td><p class="text-primary"><b>Platform</b></p></td>
                        <td>{{data.model}}</td>
                    </tr>
                    <tr>
                        <td><p class="text-primary"><b>Serial</b></p></td>
                        <td>{{data.raw_data["subjectSerialNumber"]}}</td>
                    </tr>
                    <tr>
                        <td><p class="text-primary"><b>Version</b></p></td>
                        <td>{{data.version}}</td>
                    </tr>
                    <tr>
                        <td><p class="text-primary"><b>Template</b></p></td>
                        <td>{{data.raw_data["template"]}}</td>
                    </tr>
                    <tr>
                        <td><p class="text-primary"><b>Uptime (days)</b></p></td>
                        <td>{{data.uptime}}</td>
                    </tr>
                </table>
                </div>
                <div class="col">
                <div id="map" style="height: 96%;"></div>
                </div>
                </div>
            </div>
            
        </div>
        <div class="tab-pane fade" id="tab2" role="tabpanel">
            <div id="tab2-content"></div>
        </div>
        <div class="tab-pane fade" id="tab3" role="tabpanel">
            <div id="tab3-content"><table id="interfaceTable" class="table table-striped"></table></div>
        </div>
        <div class="tab-pane fade" id="tab4" role="tabpanel">
            <div id="tab4-content"><table id="templateValuesTable" class="table table-striped"></table></div>
        </div>
        <div class="tab-pane fade" id="tab5" role="tabpanel">
            <div id="tab5-content">
    <!-- ip route tab content -->
        <div class="row">
            <div id="iprouteFormContainer" class="col-lg-10">

            </div>
            <div id="iprouteSVGContainer" class="col-lg-12" style="width: 100%; height: 1000px">
            </div>
        </div>
    <!-- end of ip route tab content -->

            </div>
        </div>
    </div>
    </div>
</div>
{% endblock %}

{% block script %}

<script>
    const id = "{{id}}";
    const hostname = "{{hostname}}";
    const fabric = "{{fabric}}";
    const data = JSON.parse('{{data.tojson()|safe}}');
    const pollInterval = 2000;
    const resolveDnsUrl = "{{url_for('resolve')}}";
    const createTaskUrl = "{{url_for('api_tasks.create_task')}}";
    const getTaskUrl = "{{url_for('api_tasks.get_task',task_id='DUMMY')}}";
    const showInterfaceUrl = "{{url_for('ui_sdwan.show_interface',fabric='FABRIC',id='ID',if_name='IF')}}";
    const getDeviceTemplateValuesUrl = "{{url_for('api_sdwan.get_device_template_values',fabric='FABRIC',device_id='DEVICE_ID',template_id='TEMPLATE_ID')}}";
    const getDeviceRouteTableUrl = "{{url_for('api_sdwan.get_device_route_table',fabric='FABRIC',device_id='DEVICE_ID')}}";
    
    // Tasks definitions
    const tasks = [
        {
            type: "ssh_cmd",
            params: {
                ip_address: data.system_ip,
                use_textfsm: false,
                device_type: "cisco_ios",
                cmd: "sh version"
            },
            render: (result) => {
                console.log(result);
                if (result.success) {
                    $("#tab2-content").html(`<pre><code>${escapeHtml(result.raw)}</code></pre>`);
                } else {
                    $("#tab2-content").html(`<pre><code>❌ Task failed: ${result.error}</code></pre>`);
                }
            }
        },
        {
            type: "ssh_cmd",
            params: {
                ip_address: data.system_ip,
                use_textfsm: true,
                device_type: "cisco_ios",
                cmd: "sh int"
            },
            render: (result) => {
                console.log(result);
                if (result.success) {
                    $("#interfaceTable").DataTable({
                        layout: {
                            topStart: 'search',
                            topEnd: { buttons: ['pageLength', 'copy', 'excel', 'csv'] }
                        },
                        pageLength: 15,
                        fixedHeader: true,
                        data: result.parsed,
                        columns: [
                            {
                                title: 'Interface', data: "interface", render: function (data, type, row) {
                                    const ifLink = data.replaceAll("/", "_");
                                    return `<b><a class="text-primary" href=${showInterfaceUrl.replace('FABRIC', fabric).replace('ID', id).replace('IF', ifLink)}>${row.interface}</a></b>`;
                                }
                            },
                            { title: 'Description', data: "description" },
                            {
                                title: 'Status', data: "protocol_status", render: function (data, type, row) {
                                    if (data.startsWith("up")) {
                                        return `<p class="text-success">${data}</p>`;
                                    } else {
                                        return `<p class="text-danger">${data}</p>`;
                                    }
                                }
                            },
                            { title: 'Speed', data: "speed" },
                            { title: 'Duplex', data: "duplex" },
                            { title: 'inRate', data: "input_rate" },
                            { title: 'outRate', data: "output_rate" },
                            { title: 'inErrors', data: "input_errors" },
                            { title: 'outErrors', data: "output_errors" },
                            { title: 'queueDrops', data: "queue_drops" },
                        ]
                    });
                } else {
                    $("#tab3-content").html(`<pre><code>❌ Task failed: ${result.error}</code></pre>`);
                }
            }
        }
    ];

    // Run tasks
    $(document).ready(function () {
        // add map
        var map = L.map('map').setView([data.latitude, data.longitude], 13);
        // openstreetmap layer
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        // marker
        var marker = L.marker([data.latitude, data.longitude]).addTo(map);

        // run commands
        show('#spinner');
        show_alert("info","Hang on",`Loading data from ${hostname}...`);
        runTasks(tasks).then((results) => {
            results.forEach((task, i) => {
                if (task.render) {
                    if (task.render_params !== undefined) {
                        task.render(task.result, task.render_params);
                    } else {
                        task.render(task.result);
                    }
                }
            });
        }).finally(() => {
            close_alert();
            hide("#spinner");
        });

        // get template values
        get(getDeviceTemplateValuesUrl.replace("FABRIC",fabric).replace("DEVICE_ID",id).replace("TEMPLATE_ID",data.template_id)).then(values=>{
            console.log(values);
            // Convert object into array of { key: ..., value: ... }
            const keyValueArray = Object.entries(values).map(([key, value]) => {
                return { key, value };
            });
            $("#templateValuesTable").DataTable({
                layout: {
                    topStart: 'search',
                    topEnd: { buttons: ['pageLength', 'copy', 'excel', 'csv'] }
                },
                pageLength: 15,
                fixedHeader: true,
                data: keyValueArray,
                columns: [
                    { data: 'key', title: 'Template Variable' },
                    { data: 'value', title: 'Value' }
                ]
            });
        }).catch(error=>{
        });

        // get route table
        //get(getDeviceRouteTableUrl.replace("FABRIC",fabric).replace("DEVICE_ID",data.system_ip)).then(values=>{
        //    console.log(values);


        //}).catch(error=>{
        //});
    });

</script>


<!-- ip route -->
 <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="{{ url_for('static' , filename='js/iproute.js') }}" type="text/javascript"></script>
<script>
  $(document).ready(function () {
    const deviceId   = data.system_ip;
    console.log("deviceId=",deviceId);
    // Default diagram
    //$("a.iproute").click(function (e) {
        //e.preventDefault();
      //show('spinner');

      let cache = sessionStorage.getItem('iprouteCache-'+deviceId);
      if (cache != null) {
        let data = JSON.parse(cache);
        let hierarchy = iprouteHierarchy(data);
        let svg = iprouteSVG(hierarchy, '#iprouteSVGContainer');
        $('#iprouteSVGContainer').html(svg);
      }
      get(getDeviceRouteTableUrl.replace("FABRIC",fabric).replace("DEVICE_ID",deviceId)).then(data=>{
        console.log(data);
        // Save to sessionStorage
        sessionStorage.setItem('iprouteCache-'+deviceId,JSON.stringify(data));
        //if (data.hasOwnProperty('data')) {
        //  sessionStorage.setItem('iprouteCache-'+deviceId,JSON.stringify(data));
        //} else {
        //  $('#iprouteSVGContainer').html(makeAlert('warning','Oops!','Failed to get data; please retry',false));
        //}
        //hide('spinner');
        iprouteForm('iprouteForm',data,function(form){
          $('#iprouteFormContainer').html(form);
          // callback function to register Refresh diagram button
          $("a.iprouteRefresh").click(function (e) {
            // Read filter, get data & display diagram
            let data = JSON.parse(sessionStorage.getItem('iprouteCache-'+deviceId));
            let filtered = iprouteFilter(data,'#iprouteForm');
            let hierarchy = iprouteHierarchy(filtered);
            let svg = iprouteSVG(hierarchy, '#iprouteSVGContainer');
            $('#iprouteSVGContainer').html(svg);
          });
        });
        // Initial load: compute data and display diagram
        let hierarchy = iprouteHierarchy(data,'');
        let svg       = iprouteSVG(hierarchy,'#iprouteSVGContainer');
        $('#iprouteSVGContainer').html(svg);
      });
    //});
  });

</script>

{% endblock %}