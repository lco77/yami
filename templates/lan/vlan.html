{% extends "base.html" %}

{% block title %}Yami{% endblock %}

{% block content %}
<div class="row">
    <div class="col">
        <br>
        <h4>{{hostname}} - Vlan {{vlan}} ({{name}})</h4>
        <hr>
    </div>
</div>
<div class="row">
    <div class="col">
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" data-bs-toggle="tab" href="#tab1" aria-selected="true" role="tab">Interfaces</a>
        </li>
    </ul>
    <div class="tab-content">
        <div class="tab-pane fade active show" id="tab1" role="tabpanel">
            <div id="tab1-content">
                <table id="vlanTable" class="table table-striped"></table>
            </div>
        </div>
    </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    const id = "{{id}}";
    const vlan = "{{vlan}}";
    const hostname = "{{data.hostname}}";
    const fabric = "{{fabric}}";
    const deviceType = "{{device_type}}";
    const data = JSON.parse('{{data.to_json()|safe}}');
    const pollInterval = 2000;
    const resolveDnsUrl = "{{url_for('resolve')}}";
    const createTaskUrl = "{{url_for('api_tasks.create_task')}}";
    const getTaskUrl = "{{url_for('api_tasks.get_task',task_id='DUMMY')}}";
    const showInterfaceUrl = "{{ url_for('ui_lan.show_interface',fabric='FABRIC',id='ID',if_name='IF') }}";

    // Tasks definitions
    const tasks = [
        {
            type: "ssh_cmd",
            params: {
                ip_address: data.ip_address,
                use_textfsm: true,
                device_type: deviceType,
                cmd: `show interface`
            }
        },
        {
            type: "ssh_cmd",
            params: {
                ip_address: data.ip_address,
                use_textfsm: true,
                device_type: deviceType,
                cmd: `show interface switchport`
            }
        },
        {
            type: "ssh_cmd",
            params: {
                ip_address: data.ip_address,
                use_textfsm: true,
                device_type: deviceType,
                cmd: `show spanning-tree vlan ${vlan}`
            }
        }
    ];

    // Run tasks
    $(document).ready(function () {
        show('#spinner');
        show_alert("info","Hang on",`Loading data from ${hostname}...`);
        runTasks(tasks).then((results) => {

            // run embedded render functions if any
            results.forEach((task, i) => {
                if (task.render) {
                    if (task.render_params !== undefined) {
                        task.render(task.result, task.render_params);
                    } else {
                        task.render(task.result);
                    }
                }
            });

            // get result index for each command we're interested in
            const indexShInt = results.findIndex(obj => obj.params.cmd === "show interface");
            const indexShIntSwitchport = results.findIndex(obj => obj.params.cmd === "show interface switchport");
            const indexShSpaVlan = results.findIndex(obj => obj.params.cmd === `show spanning-tree vlan ${vlan}`);

            // get actual result
            const arrayShInt = results[indexShInt].result.parsed;
            const arrayShIntSwitchport = results[indexShIntSwitchport].result.parsed;
            const arrayShSpaVlan = results[indexShSpaVlan].result.parsed;

            // parse data
            const parsedVlanData = parseVlanData(arrayShInt, arrayShIntSwitchport, arrayShSpaVlan, vlan);

            // render table
            $("#vlanTable").DataTable({
                    layout: {
                        topStart: 'search',
                        topEnd: { buttons: ['pageLength', 'copy', 'excel', 'csv'] }
                    },
                    pageLength: 10,
                    fixedHeader: true,
                    data: parsedVlanData,
                    order: [[6, 'desc']],
                    columns: [
                        {
                            title: 'Interface', data: "interface", render: function (data, type, row) {
                                if (type === 'display') {
                                    const ifLink = data.replaceAll("/", "_");
                                    return `<b><a class="text-primary" href=${showInterfaceUrl.replace('FABRIC', fabric).replace('ID', id).replace('IF', ifLink)}>${row.interface}</a></b>`;
                                } else {
                                    return data;
                                    //return row.port_id;
                                }
                            }
                        },
                        { title: 'Description', data: "description" },
                        
                        {
                            title: 'Status', data: "status", render: function (data, type, row) {
                                if (type === 'display') {
                                    return data==="up" ? "<p class='text-center'><i class='bi bi-check-circle-fill text-success'></i></p>" : "<p class='text-center'><i class='bi bi-x-circle-fill text-danger'></i></p>";
                                }
                                return data;
                            }
                        },
                        { title: 'Mode', data: "mode" },
                        { title: 'Vlans', data: "vlans_str" },
                        { title: 'STP Cost', data: "stp_cost" },
                        { title: 'STP Priority', data: "stp_priority" },
                        { title: 'STP Role', data: "stp_role" },
                        { title: 'STP Status', data: "stp_status" },
                        { title: 'STP Type', data: "stp_type" },
                    ]
            });
        }).finally(() => {
            close_alert();
            hide("#spinner");
        });
    });

</script>
{% endblock %}