{% extends "base.html" %}

{% block title %}Yami{% endblock %}

{% block content %}
<div class="row">
    <div class="col">
        <br>
        <h4>{{hostname}}</h4>
        <hr>
    </div>
</div>
<div class="row">
    <div class="col">
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" data-bs-toggle="tab" href="#tab1" aria-selected="true" role="tab">Summary</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" data-bs-toggle="tab" href="#tab2" aria-selected="false" role="tab" tabindex="-1">Version</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link text-info" data-bs-toggle="tab" href="#tab3" aria-selected="false" role="tab" tabindex="-1">Interfaces</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link text-info" data-bs-toggle="tab" href="#tab4" aria-selected="false" role="tab" tabindex="-1">Vlans</a>
        </li>
    </ul>
    <div class="tab-content">
        <div class="tab-pane fade active show" id="tab1" role="tabpanel">
            <div id="tab1-content">
                <div class="row">
                    <div class="col">
                        <table class="table table-striped">
                            <tr>
                                <td>
                                    <p class="text-primary"><b>Hostname</b></p>
                                </td>
                                <td>{{data.hostname}}</td>
                            </tr>
                            <tr>
                                <td>
                                    <p class="text-primary"><b>IP Address</b></p>
                                </td>
                                <td>{{data.ip_address}}</td>
                            </tr>
                            <tr>
                                <td>
                                    <p class="text-primary"><b>Platform</b></p>
                                </td>
                                <td>{{data.platform | join('<br>') | safe}}</td>
                            </tr>
                            <tr>
                                <td>
                                    <p class="text-primary"><b>Serial</b></p>
                                </td>
                                <td>{{data.serial | join('<br>') | safe}}</td>
                            </tr>
                            <tr>
                                <td>
                                    <p class="text-primary"><b>Version</b></p>
                                </td>
                                <td>{{data.version}}</td>
                            </tr>
                            <tr>
                                <td>
                                    <p class="text-primary"><b>Stack size</b></p>
                                </td>
                                <td>{{data.stack_size}}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col">

                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="tab2" role="tabpanel">
            <div id="tab2-content"></div>
        </div>
        <div class="tab-pane fade" id="tab3" role="tabpanel">
            <div id="tab3-content"><table id="interfaceTable" class="table table-striped"></table></div>
        </div>
        <div class="tab-pane fade" id="tab4" role="tabpanel">
            <div id="tab4-content"><table id="vlanTable" class="table table-striped"></table></div>
        </div>
    </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    const id = "{{id}}";
    const hostname = "{{hostname}}";
    const fabric = "{{fabric}}";
    const deviceType = "{{device_type}}";
    const data = JSON.parse('{{data.to_json()|safe}}');
    const pollInterval = 2000;
    const resolveDnsUrl = "{{url_for('resolve')}}";
    const createTaskUrl = "{{url_for('api_tasks.create_task')}}";
    const getTaskUrl = "{{url_for('api_tasks.get_task',task_id='DUMMY')}}";
    const showInterfaceUrl = "{{ url_for('ui_lan.show_interface',fabric='FABRIC',id='ID',if_name='IF') }}";
    const showVlanUrl = "{{ url_for('ui_lan.show_vlan',fabric='FABRIC',id='ID',vlan='VLAN') }}";

    // Tasks definitions
    let tasks = [
        {
            type: "ssh_cmd",
            params: {
                ip_address: data.ip_address,
                use_textfsm: false,
                device_type: deviceType,
                cmd: "sh version"
            },
            render: (result) => {
                if (result.success) {

                    $("#tab2-content").html(`<pre><code>${escapeHtml(result.raw)}</code></pre>`);
                } else {
                    $("#tab2-content").html(`<pre><code>❌ Task failed: ${result.error}</code></pre>`);
                }
            }
        },
        {
            type: "ssh_cmd",
            params: {
                ip_address: data.ip_address,
                use_textfsm: true,
                device_type: deviceType,
                cmd: "show interface"
            }
        },
        {
            type: "ssh_cmd",
            params: {
                ip_address: data.ip_address,
                use_textfsm: true,
                device_type: deviceType,
                cmd: "show vlan",
            },
            render: (result) => {
                if (result.success) {
                    $("#vlanTable").DataTable({
                        layout: {
                            topStart: 'search',
                            topEnd: { buttons: ['pageLength', 'copy', 'excel', 'csv'] }
                        },
                        pageLength: 10,
                        fixedHeader: true,
                        order: [[2, 'asc']],
                        data: result.parsed.filter(obj => !["1002", "1003", "1004", "1005"].includes(obj.vlan_id)),
                        columns: [
                            {
                                title: 'Name', data: "vlan_name", render: function (data, type, row) {
                                    return `<b><a class="text-primary" href=${showVlanUrl.replace('FABRIC', fabric).replace('ID',id).replace('VLAN',row.vlan_id)}?name=${data}>${data}</a></b>`
                                }
                            },
                            {
                                title: 'Status', data: "status", render: function (data, type, row) {
                                    if (type === 'display') {
                                        return data === "active" ? "<p class='text-center'><i class='bi bi-check-circle-fill text-success'></i></p>" : "<p class='text-center'><i class='bi bi-x-circle-fill text-danger'></i></p>";
                                    }
                                    return data === "active" ? true : false;
                                }
                            },
                            { title: 'ID', data: "vlan_id" },
                            {
                                title: '# Access Interfaces', data: "interfaces", render: function (data, type, row) {
                                    if (type === 'display') {
                                        return data.length;
                                    }
                                    return data.length;
                                }
                            },
                        ]
                    });
                } else {
                    $("#tab4-content").html(`<pre><code>❌ Task failed: ${result.error}</code></pre>`);
                }
            }
        },
        {
            type: "ssh_cmd",
            params: {
                ip_address: data.ip_address,
                use_textfsm: true,
                device_type: deviceType,
                cmd: "show spanning-tree"
            }
        }
    ];

    // Add sh interface link on C9xxx platforms
    if (data.platform.some(p => p.startsWith("C9"))) {
        tasks.push({
            type: "ssh_cmd",
            params: {
                ip_address: data.ip_address,
                use_textfsm: false,
                device_type: deviceType,
                cmd: "show interface link"
            }
        });
    }

    // Run tasks
    $(document).ready(function () {
        show('#spinner');
        show_alert("info","Hang on",`Loading data from ${hostname}...`);
        runTasks(tasks).then((results) => {

            // Utility function to merge "sh int link" with "sh int"
            function enrichInterfaces(primaryArray, optionalArray = []) {
                // Build a lookup map from the optional array
                const optionalMap = Object.fromEntries(
                    optionalArray.map(obj => [obj.interface, obj])
                );
                // Enrich primary array
                return primaryArray.map(obj => {
                    const match = optionalMap[obj.interface] || {};
                    return {
                        ...obj,
                        uptime: match.uptime ?? null,
                        downtime: match.downtime ?? null,
                        uptime_seconds: match.uptime_seconds ?? null,
                        downtime_seconds: match.downtime_seconds ?? null
                    };
                });
            }

            // Render tasks results with embedded render functions ("sh ver")
            results.forEach((task, i) => {
                if (task.render) {
                    if (task.render_params !== undefined) {
                        task.render(task.result, task.render_params);
                    } else {
                        task.render(task.result);
                    }
                }
            });

            // Find results of "sh int" and "sh int link" + merge data
            const indexShIntArray = results.findIndex(obj => obj.params.cmd === "show interface");
            const indexShIntLinkArray = results.findIndex(obj => obj.params.cmd === "show interface link");
            if (results[indexShIntArray].result.success) {
                const shIntArray = results[indexShIntArray].result.parsed;
                let shIntLinkArray = [];
                if (indexShIntLinkArray !== -1 && results[indexShIntLinkArray].result.success) {
                    shIntLinkArray = parseShIntLink(results[indexShIntLinkArray].result.raw);
                }
                const interfaceData = enrichInterfaces(shIntArray, shIntLinkArray);

                // Render merged data
                $("#interfaceTable").DataTable({
                    layout: {
                        topStart: 'search',
                        topEnd: { buttons: ['pageLength', 'copy', 'excel', 'csv'] }
                    },
                    pageLength: 10,
                    fixedHeader: true,
                    data: interfaceData,
                    columns: [
                        {
                            title: 'Interface', data: "interface", render: function (data, type, row) {
                                const ifLink = data.replaceAll("/", "_");
                                return `<b><a class="text-primary" href=${showInterfaceUrl.replace('FABRIC', fabric).replace('ID', id).replace('IF', ifLink)}>${row.interface}</a></b>`;
                            }
                        },
                        { title: 'Description', data: "description" },
                        {
                            title: 'Status', data: "protocol_status", render: function (data, type, row) {
                                if (type === 'display') {
                                    return data.startsWith("up") ? "<p class='text-center'><i class='bi bi-check-circle-fill text-success'></i></p>" : "<p class='text-center'><i class='bi bi-x-circle-fill text-danger'></i></p>";
                                } else {
                                    return data.startsWith("up") ? true : false
                                }
                                if (data.startsWith("up")) {
                                    return `<p class="text-success">${data}</p>`;
                                } else {
                                    return `<p class="text-danger">${data}</p>`;
                                }
                            }
                        },
                        { title: 'Speed', data: "speed" },
                        { title: 'Duplex', data: "duplex" },
                        {
                            title: 'Uptime', data: "uptime", render: function (data, type, row) {
                                if (type === 'display') {
                                    return data == null || data == "00:00:00" ? "" : data;
                                }
                                return row.uptime_seconds;
                            }
                        },
                        {
                            title: 'Downtime', data: "downtime", render: function (data, type, row) {
                                if (type === 'display') {
                                    return data == null || data == "00:00:00" ? "" : data;
                                }
                                return row.downtime_seconds;
                            }
                        },
                        {
                            title: 'inRate', data: "input_rate", render: function (data, type, row) {
                                if (type === 'display') {
                                    return formatBitrate(data);
                                }
                                return data;
                            }
                        },
                        {
                            title: 'outRate', data: "output_rate", render: function (data, type, row) {
                                if (type === 'display') {
                                    return formatBitrate(data);
                                }
                                return data;
                            }
                        },
                        { title: 'inErrors', data: "input_errors" },
                        { title: 'outErrors', data: "output_errors" },
                        { title: 'queueDrops', data: "queue_drops" },
                    ]
                });
                
            } else {
                $("#tab3-content").html(`<pre><code>❌ Task failed: ${results[indexShIntArray].result.error}</code></pre>`);
            }
        
        }).finally(() => {
            close_alert();
            hide("#spinner");
        });
    });

</script>
{% endblock %}