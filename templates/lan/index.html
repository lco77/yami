{% extends "base.html" %}

{% block title %}Yami{% endblock %}

{% block content %}
<div class="row">
    <div class="col">
        <br>
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">LAN</h4>
            <div id="fabric-buttons" class="btn-group" role="group" aria-label="Fabric selection">
                {% for item in fabrics %}
                <button type="button" class="btn btn-outline-primary fabric-btn" data-fabric="{{ item }}">
                    {{ item }}
                </button>
                {% endfor %}
            </div>
        </div>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col">
        <table id="table"  class="table table-striped align-top"></table>
    </div>
</div>


{% endblock %}

{% block script %}
<script>
    let fabric = "{{ fabrics[0] }}"; // default to first fabric
    const getDevicesUrl = "{{ url_for('api_dnac.get_devices',fabric='FABRIC') }}";
    const showDeviceUrl = "{{ url_for('ui_lan.show_device',fabric='FABRIC',id='ID') }}";

    // init datatable
    let table = new DataTable('#table',{
                layout: {
                    topStart: 'search',
                    topEnd: { buttons: ['pageLength', 'copy', 'excel', 'csv'] }
                },
                pageLength: 10,
                fixedHeader: true,
                order: [[1, 'asc']],
                columns: [
                    {
                        title: 'Reachable', data: "raw_data.communicationState", render: function (data, type, row) {
                            if (type === 'display') {
                                return data==="REACHABLE" ? "<p class='text-center'><i class='bi bi-check-circle-fill text-success'></i></p>" : "<p class='text-center'><i class='bi bi-x-circle-fill text-danger'></i></p>";
                            }
                            return data==="REACHABLE" ? true : false;
                        }
                    },
                    {
                        title: 'Hostname', data: "hostname", render: function (data, type, row) {
                            return `<b><a class="text-primary" href=${showDeviceUrl.replace('FABRIC', fabric).replace('ID',row.id)}>${row.hostname}</a></b>`
                        }
                    },
                    { title: 'IP Address', data: "ip_address" },
                    { title: 'Role', data: "role" },
                    { title: 'Version', data: "version" },
                    {
                        title: 'Model', data: "platform", render: function (data, type, row) {
                            if (data) {
                                return data.join('<br>');
                            } else {
                                return null;
                            }
                        }
                    },
                    {
                        title: 'Serial', data: "serial", render: function (data, type, row) {
                            if (data) {
                                return data.join('<br>');
                            } else {
                                return null;
                            }
                        }
                    },
                    { title: 'Stack Size', data: "stack_size" },
                    {
                        title: 'Uptime (d)', data: "uptime", render: function (data, type, row) {
                            if (type === 'display') {
                                return Math.floor(data / 86400);
                            }
                            return data;
                        }
                    },
                    
                ]
            });

    // get data and render table
    $(document).ready(function () {

        // Add 'active' class to the first button
        $('#fabric-buttons .fabric-btn').first().addClass('active');
        loadData(fabric);

        // Click handler to update the fabric variable
        $('.fabric-btn').on('click', function () {
            $('.fabric-btn').removeClass('active');
            $(this).addClass('active');
            fabric = $(this).data('fabric');
            loadData(fabric);
        });

        function loadData(fabric) {
            show('#spinner');
            let url = getDevicesUrl.replace('FABRIC', fabric) + "?family=Switches and Hubs";
            get(url)
                .then(data => {
                    table.clear().rows.add(data).draw();
                    hide('#spinner');
                })
                .catch(error => {
                    show_alert("danger", "Failed to contact Cisco DNAC", error)
                    hide('#spinner');
                    console.log(error);
                });
        };

    });
</script>
{% endblock %}